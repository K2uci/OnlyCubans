{% extends "content/base/base.html" %}
{% load static %}

{% block title %}Mi Feed - OnlyCubans{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/content/feeds/feeds.css' %}">
<link rel="stylesheet" href="{% static 'css/content/feeds/feed_home.css' %}">
{% endblock %}

{% block content %}
<div class="feeds-container">
    <!-- Feed Header -->
    <div class="feed-header">
        <nav class="feed-nav">
            <a href="{% url 'content:home_feed' %}" class="feed-nav-item active">
                <i class="fas fa-home"></i>
                <span>Mi Feed</span>
            </a>
            <a href="{% url 'content:discover_feed' %}" class="feed-nav-item">
                <i class="fas fa-compass"></i>
                <span>Descubrir</span>
            </a>
            <a href="{% url 'content:post_list' %}" class="feed-nav-item">
                <i class="fas fa-fire"></i>
                <span>Trending</span>
            </a>
        </nav>

        <div class="feed-filters">
            <div class="filter-group">
                <span class="filter-label">Ordenar por:</span>
                <select class="filter-select" onchange="updateFeedSort(this.value)">
                    <option value="recent">Más reciente</option>
                    <option value="popular">Más popular</option>
                    <option value="trending">Trending</option>
                </select>
            </div>
            
            <div class="filter-group">
                <span class="filter-label">Tipo:</span>
                <select class="filter-select" onchange="updateFeedType(this.value)">
                    <option value="all">Todo el contenido</option>
                    <option value="public">Solo público</option>
                    <option value="premium">Solo premium</option>
                </select>
            </div>
        </div>
    </div>

    <div class="feed-grid">
        <!-- Contenido Principal -->
        <div class="feed-main">
            <!-- Crear Post -->
            <div class="home-feed">
                <div class="feed-create-post">
                    <div class="create-post-header">
                        <img src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" 
                             alt="{{ user.username }}" 
                             class="create-post-avatar">
                        <div class="create-post-prompt">¿Qué quieres compartir hoy, {{ user.username }}?</div>
                    </div>
                    <div class="create-post-actions">
                        <a href="{% url 'content:post_create' %}" class="create-post-btn">
                            <i class="fas fa-edit"></i>
                            <span>Crear Post</span>
                        </a>
                        <a href="#" class="create-post-btn">
                            <i class="fas fa-image"></i>
                            <span>Foto/Video</span>
                        </a>
                        <a href="#" class="create-post-btn">
                            <i class="fas fa-poll"></i>
                            <span>Encuesta</span>
                        </a>
                    </div>
                </div>

                <!-- Stories -->
                <div class="feed-stories">
                    <div class="stories-title">Historias</div>
                    <div class="stories-container">
                        <a href="#" class="story-item story-add">
                            <div class="story-avatar">
                                <img src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" 
                                     alt="{{ user.username }}">
                            </div>
                            <div class="story-add-icon">+</div>
                            <div class="story-username">Tu historia</div>
                        </a>
                        <!-- Stories de usuarios seguidos -->
                        {% for followed_user in followed_users|slice:":10" %}
                        <a href="#" class="story-item">
                            <img src="{% if followed_user.profile_picture %}{{ followed_user.profile_picture.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" 
                                 alt="{{ followed_user.username }}" 
                                 class="story-avatar">
                            <div class="story-username">{{ followed_user.username }}</div>
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <!-- Contenido del Feed -->
                <div class="feed-content">
                    <div class="feed-sort">
                        <h3 class="feed-sort-title">Publicaciones recientes</h3>
                        <div class="feed-sort-options">
                            <button class="sort-option active" data-sort="recent">Recientes</button>
                            <button class="sort-option" data-sort="popular">Populares</button>
                            <button class="sort-option" data-sort="following">Siguiendo</button>
                        </div>
                    </div>

                    <div class="feed-posts">
                        {% if page_obj %}
                            {% for post in page_obj %}
                                {% include "content/base/post_card.html" with post=post %}
                            {% endfor %}

                            <!-- Paginación -->
                            {% include "content/base/pagination.html" with page_obj=page_obj %}
                        {% else %}
                            <!-- Estado vacío -->
                            <div class="feed-empty-state">
                                <i class="fas fa-newspaper feed-empty-icon"></i>
                                <h3 class="feed-empty-title">Tu feed está vacío</h3>
                                <p class="feed-empty-description">
                                    Comienza siguiendo a algunos creadores para ver su contenido aquí, 
                                    o explora contenido nuevo en la sección de Descubrir.
                                </p>
                                <div class="empty-state-actions">
                                    <a href="{% url 'content:discover_feed' %}" class="btn btn-primary">
                                        <i class="fas fa-compass"></i> Explorar Contenido
                                    </a>
                                    <a href="#" class="btn btn-social">
                                        <i class="fas fa-users"></i> Descubrir Creadores
                                    </a>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="feed-sidebar">
            <!-- Creadores Sugeridos -->
            <div class="sidebar-widget">
                <div class="widget-header">
                    <h3><i class="fas fa-user-plus"></i> Creadores Sugeridos</h3>
                </div>
                <div class="widget-content">
                    <div class="suggested-creators">
                        {% for suggested_creator in suggested_creators|slice:":5" %}
                        <div class="creator-item">
                            <img src="{% if suggested_creator.profile_picture %}{{ suggested_creator.profile_picture.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" 
                                 alt="{{ suggested_creator.username }}" 
                                 class="creator-avatar-sm">
                            <div class="creator-details">
                                <div class="creator-name">{{ suggested_creator.username }}</div>
                                <div class="creator-category">{{ suggested_creator.creator_profile.category|default:"Creador" }}</div>
                            </div>
                            <button class="follow-btn" data-user-id="{{ suggested_creator.id }}">Seguir</button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Trending -->
            <div class="sidebar-widget">
                <div class="widget-header">
                    <h3><i class="fas fa-fire"></i> Trending Hoy</h3>
                </div>
                <div class="widget-content">
                    <div class="trending-list">
                        {% for trending_post in trending_posts|slice:":5" %}
                        <div class="trending-item">
                            <span class="trending-rank">{{ forloop.counter }}</span>
                            <div class="trending-content">
                                <div class="trending-title">{{ trending_post.title|truncatewords:4 }}</div>
                                <div class="trending-metrics">{{ trending_post.views_count }} vistas</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Eventos -->
            <div class="sidebar-widget">
                <div class="widget-header">
                    <h3><i class="fas fa-calendar-alt"></i> Próximos Eventos</h3>
                </div>
                <div class="widget-content">
                    <div class="events-list">
                        <div class="event-item">
                            <div class="event-date">15 NOV</div>
                            <div class="event-details">
                                <div class="event-title">Concierto Virtual</div>
                                <div class="event-time">8:00 PM</div>
                            </div>
                        </div>
                        <div class="event-item">
                            <div class="event-date">20 NOV</div>
                            <div class="event-details">
                                <div class="event-title">Taller de Cocina</div>
                                <div class="event-time">3:00 PM</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// JavaScript específico para el feed principal
document.addEventListener('DOMContentLoaded', function() {
    // Funcionalidad de ordenamiento
    const sortOptions = document.querySelectorAll('.sort-option');
    sortOptions.forEach(option => {
        option.addEventListener('click', function() {
            sortOptions.forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
            const sortType = this.dataset.sort;
            updateFeedSort(sortType);
        });
    });

    // Funcionalidad de seguir usuarios
    const followButtons = document.querySelectorAll('.follow-btn');
    followButtons.forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.dataset.userId;
            toggleFollow(userId, this);
        });
    });

    // Carga infinita al hacer scroll
    window.addEventListener('scroll', function() {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 1000) {
            loadMorePosts();
        }
    });
});

function updateFeedSort(sortType) {
    console.log('Ordenar por:', sortType);
    // Implementar lógica de ordenamiento
}

function toggleFollow(userId, button) {
    // Implementar lógica de seguir/dejar de seguir
    button.classList.toggle('following');
    button.textContent = button.classList.contains('following') ? 'Siguiendo' : 'Seguir';
}

function loadMorePosts() {
    // Implementar carga infinita
    console.log('Cargando más posts...');
}
</script>
{% endblock %}