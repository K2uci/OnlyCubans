{% extends "content/base/base.html" %}
{% load static %}

{% block title %}{{ category.name }} - OnlyCubans{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/content/feeds/feeds.css' %}">
<link rel="stylesheet" href="{% static 'css/content/feeds/feed_category.css' %}">
{% endblock %}

{% block content %}
<div class="feeds-container">
    <!-- Feed Header -->
    <div class="feed-header">
        <nav class="feed-nav">
            <a href="{% url 'content:home_feed' %}" class="feed-nav-item">
                <i class="fas fa-home"></i>
                <span>Mi Feed</span>
            </a>
            <a href="{% url 'content:discover_feed' %}" class="feed-nav-item">
                <i class="fas fa-compass"></i>
                <span>Descubrir</span>
            </a>
            <a href="{% url 'content:post_list' %}" class="feed-nav-item">
                <i class="fas fa-fire"></i>
                <span>Trending</span>
            </a>
        </nav>

        <div class="feed-filters">
            <div class="filter-group">
                <span class="filter-label">Ordenar por:</span>
                <select class="filter-select" onchange="updateCategorySort(this.value)">
                    <option value="recent">Más reciente</option>
                    <option value="popular">Más popular</option>
                    <option value="trending">Trending</option>
                </select>
            </div>
            
            <div class="filter-group">
                <span class="filter-label">Tipo:</span>
                <select class="filter-select" onchange="updateContentType(this.value)">
                    <option value="all">Todo el contenido</option>
                    <option value="free">Gratuito</option>
                    <option value="premium">Premium</option>
                </select>
            </div>
        </div>
    </div>

    <div class="feed-grid">
        <!-- Contenido Principal -->
        <div class="feed-main">
            <div class="category-feed">
                <!-- Header de la Categoría -->
                <div class="category-header">
                    <div class="category-icon">
                        <i class="fas fa-{{ category.icon|default:'tag' }}"></i>
                    </div>
                    <h1 class="category-name">{{ category.name }}</h1>
                    <p class="category-description">
                        {{ category.description|default:"Explora el mejor contenido de "|add:category.name|add:" en la comunidad cubana" }}
                    </p>
                    
                    <div class="category-stats">
                        <div class="category-stat">
                            <span class="category-stat-value">{{ category.content_count }}</span>
                            <span class="category-stat-label">Publicaciones</span>
                        </div>
                        <div class="category-stat">
                            <span class="category-stat-value">{{ active_creators }}</span>
                            <span class="category-stat-label">Creadores Activos</span>
                        </div>
                        <div class="category-stat">
                            <span class="category-stat-value">{{ total_views }}</span>
                            <span class="category-stat-label">Vistas Totales</span>
                        </div>
                    </div>
                </div>

                <!-- Contenido de la Categoría -->
                <div class="category-content">
                    <!-- Ordenamiento -->
                    <div class="category-sort">
                        <h3 class="sort-title">Contenido de {{ category.name }}</h3>
                        <div class="sort-options">
                            <button class="sort-option active" data-sort="recent">Recientes</button>
                            <button class="sort-option" data-sort="popular">Populares</button>
                            <button class="sort-option" data-sort="trending">Trending</button>
                        </div>
                    </div>

                    <!-- Creadores Destacados -->
                    <div class="top-creators">
                        <h4 class="section-title">
                            <i class="fas fa-crown"></i>
                            Creadores Destacados en {{ category.name }}
                        </h4>
                        <div class="creators-carousel">
                            {% for top_creator in top_creators|slice:":8" %}
                            <a href="{% url 'content:creator_feed' top_creator.username %}" class="creator-item">
                                <img src="{% if top_creator.profile_picture %}{{ top_creator.profile_picture.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" 
                                     alt="{{ top_creator.username }}" 
                                     class="creator-avatar">
                                <div class="creator-info">
                                    <div class="creator-username">{{ top_creator.username }}</div>
                                    <div class="creator-followers">{{ top_creator.followers_count }} seguidores</div>
                                </div>
                            </a>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Grid de Publicaciones -->
                    <div class="category-posts">
                        {% if page_obj %}
                            {% for post in page_obj %}
                                {% include "content/base/post_card.html" with post=post %}
                            {% endfor %}
                        {% else %}
                            <div class="empty-state">
                                <i class="fas fa-folder-open empty-state-icon"></i>
                                <h3 class="empty-state-title">Aún no hay contenido en esta categoría</h3>
                                <p class="empty-state-description">
                                    Sé el primero en publicar contenido de {{ category.name }} en la comunidad.
                                </p>
                                {% if user.is_authenticated %}
                                <div class="empty-state-actions">
                                    <a href="{% url 'content:post_create' %}?category={{ category.id }}" class="btn btn-primary">
                                        <i class="fas fa-plus"></i> Crear Primera Publicación
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Paginación -->
                    {% if page_obj.has_other_pages %}
                    {% include "content/base/pagination.html" with page_obj=page_obj %}
                    {% endif %}

                    <!-- Categorías Relacionadas -->
                    <div class="related-categories">
                        <h4 class="section-title">
                            <i class="fas fa-tags"></i>
                            Categorías Relacionadas
                        </h4>
                        <div class="related-grid">
                            {% for related_category in related_categories|slice:":6" %}
                            <a href="{% url 'content:category_feed' related_category.slug %}" class="related-category">
                                <div class="related-category-icon">
                                    <i class="fas fa-{{ related_category.icon|default:'tag' }}"></i>
                                </div>
                                <span class="related-category-name">{{ related_category.name }}</span>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="feed-sidebar">
            <!-- Estadísticas de la Categoría -->
            <div class="sidebar-widget">
                <div class="widget-header">
                    <h3><i class="fas fa-chart-pie"></i> Estadísticas</h3>
                </div>
                <div class="widget-content">
                    <div class="category-stats-widget">
                        <div class="stat-item">
                            <span class="stat-label">Crecimiento Mensual</span>
                            <span class="stat-value trend-up">+15%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Engagement Rate</span>
                            <span class="stat-value">8.2%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Posts/Día</span>
                            <span class="stat-value">24</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Creadores Nuevos</span>
                            <span class="stat-value trend-up">+12 este mes</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Eventos de la Categoría -->
            <div class="sidebar-widget">
                <div class="widget-header">
                    <h3><i class="fas fa-calendar-alt"></i> Eventos de {{ category.name }}</h3>
                </div>
                <div class="widget-content">
                    <div class="category-events">
                        {% for event in category_events|slice:":3" %}
                        <div class="event-item">
                            <div class="event-date">{{ event.date|date:"M d" }}</div>
                            <div class="event-details">
                                <div class="event-title">{{ event.title }}</div>
                                <div class="event-time">{{ event.time }}</div>
                                <div class="event-participants">{{ event.participants }} participantes</div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="no-events">
                            <i class="fas fa-calendar-times"></i>
                            <p>No hay eventos próximos</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Trending en la Categoría -->
            <div class="sidebar-widget">
                <div class="widget-header">
                    <h3><i class="fas fa-fire"></i> Trending en {{ category.name }}</h3>
                </div>
                <div class="widget-content">
                    <div class="category-trending">
                        {% for trending_post in category_trending|slice:":5" %}
                        <a href="{% url 'content:post_detail' trending_post.id %}" class="trending-item">
                            <span class="trending-rank">#{{ forloop.counter }}</span>
                            <div class="trending-content">
                                <div class="trending-title">{{ trending_post.title|truncatewords:4 }}</div>
                                <div class="trending-metrics">
                                    <span>{{ trending_post.views_count }} vistas</span>
                                    <span>{{ trending_post.likes_count }} likes</span>
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Newsletter de la Categoría -->
            <div class="sidebar-widget">
                <div class="widget-header">
                    <h3><i class="fas fa-bell"></i> Notificaciones</h3>
                </div>
                <div class="widget-content">
                    <div class="category-notifications">
                        <p>Recibe notificaciones cuando haya nuevo contenido en {{ category.name }}</p>
                        <button class="btn btn-outline" onclick="subscribeToCategory('{{ category.slug }}')">
                            <i class="fas fa-bell"></i>
                            Suscribirse a Notificaciones
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Ordenamiento
    const sortOptions = document.querySelectorAll('.sort-option');
    sortOptions.forEach(option => {
        option.addEventListener('click', function() {
            sortOptions.forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
            
            const sortType = this.dataset.sort;
            sortCategoryContent(sortType);
        });
    });

    function sortCategoryContent(sortType) {
        // Implementar lógica de ordenamiento
        console.log('Ordenando por:', sortType);
        // Aquí iría la lógica AJAX para reordenar el contenido
    }

    // Suscripción a notificaciones
    function subscribeToCategory(categorySlug) {
        if (confirm(`¿Deseas recibir notificaciones cuando haya nuevo contenido en ${categorySlug}?`)) {
            // Simular suscripción
            const btn = event.target;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Suscribiendo...';
            btn.disabled = true;
            
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-bell-slash"></i> Desuscribirse';
                btn.disabled = false;
                btn.onclick = () => unsubscribeFromCategory(categorySlug);
                alert('¡Te has suscrito a las notificaciones de esta categoría!');
            }, 1500);
        }
    }

    function unsubscribeFromCategory(categorySlug) {
        if (confirm(`¿Deseas dejar de recibir notificaciones de ${categorySlug}?`)) {
            const btn = event.target;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Desuscribiendo...';
            btn.disabled = true;
            
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-bell"></i> Suscribirse a Notificaciones';
                btn.disabled = false;
                btn.onclick = () => subscribeToCategory(categorySlug);
                alert('Te has desuscrito de las notificaciones de esta categoría.');
            }, 1500);
        }
    }

    // Filtros de contenido
    const filterSelects = document.querySelectorAll('.filter-select');
    filterSelects.forEach(select => {
        select.addEventListener('change', function() {
            applyCategoryFilters();
        });
    });

    function applyCategoryFilters() {
        const sortValue = document.querySelector('[onchange*="updateCategorySort"]').value;
        const typeValue = document.querySelector('[onchange*="updateContentType"]').value;
        
        console.log('Aplicando filtros:', { sort: sortValue, type: typeValue });
        // Aquí iría la lógica AJAX para aplicar los filtros
    }

    // Carrusel de creadores
    const creatorsCarousel = document.querySelector('.creators-carousel');
    if (creatorsCarousel) {
        let isDown = false;
        let startX;
        let scrollLeft;

        creatorsCarousel.addEventListener('mousedown', (e) => {
            isDown = true;
            startX = e.pageX - creatorsCarousel.offsetLeft;
            scrollLeft = creatorsCarousel.scrollLeft;
        });

        creatorsCarousel.addEventListener('mouseleave', () => {
            isDown = false;
        });

        creatorsCarousel.addEventListener('mouseup', () => {
            isDown = false;
        });

        creatorsCarousel.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - creatorsCarousel.offsetLeft;
            const walk = (x - startX) * 2;
            creatorsCarousel.scrollLeft = scrollLeft - walk;
        });
    }
});
</script>
{% endblock %}